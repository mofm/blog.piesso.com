<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>hardened .*(nt|log)s? (Posts about active directory)</title><link>https://blog.piesso.com/</link><description></description><atom:link href="https://blog.piesso.com/categories/active-directory.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><copyright>Contents © 2020 &lt;a href="mailto:emre.eryilmaz@piesso.com"&gt;mofm&lt;/a&gt; 
&lt;a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"&gt;
&lt;img alt="Creative Commons License BY-NC-SA"
style="border-width:0; margin-bottom:12px;"
src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"&gt;&lt;/a&gt;</copyright><lastBuildDate>Sat, 15 Feb 2020 15:39:10 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>FreeIPA ve Active Directory Entegrasyonu</title><link>https://blog.piesso.com/posts/freeipa-ve-active-directory-entegrasyonu/</link><dc:creator>mofm</dc:creator><description>&lt;div&gt;&lt;dl class="simple"&gt;
&lt;dt&gt;&lt;strong&gt;Kurulum oncesi hazirlik:&lt;/strong&gt;&lt;/dt&gt;
&lt;dd&gt;&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;dl class="simple"&gt;
&lt;dt&gt;FreeIPA Server 4.4.0-14 ( CentOS 7 )&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;IPA Server IP Adresi: 172.16.183.128&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;IPA Server Hostname: ipaserver.piesso.local&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;IPA Domain: piesso.local&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;IPA Netbios: PIESSO&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;IPA Kerberos realm: PIESSO.LOCAL&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;/li&gt;
&lt;li&gt;&lt;dl class="simple"&gt;
&lt;dt&gt;Windows Server 2012 R2&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;Active Directory IP Adresi: 172.16.183.132&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Active Directory Hostname: ad.pencere.local&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Active Directory Domain: pencere.local&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Active Directory Netbios: PENCERE&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;Windows Server 2012 R2 ve FreeIPA icin kerberos ticket vs gibi sorunlar yasanmamasi icin ntp ile zaman esitlemesi mutlaka baslatilmalidir. FreeIPA kurulumunda ontanimli olarak ntp client "time sync" islemini ntp pool'larindan alarak esitlemektedir. Fakat Windows Server 2012 R2 uzerinde de bunu yapmak icin manuel ntp pool sunucularini girip zaman servisini yeniden baslatilmasi gerekmektedir.&lt;/p&gt;
&lt;div class="admonition warning"&gt;
&lt;p class="admonition-title"&gt;Warning&lt;/p&gt;
&lt;p&gt;2016 Bakanlar Kurulu karari ile yaz saati uygulamasi sona erdigi icin zaman diliminin "+3" oldugunu kontrol edin.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;&lt;em&gt;(Powershell uzerinde)&lt;/em&gt;&lt;/p&gt;
&lt;pre class="code powershell"&gt;&lt;a name="rest_code_f3d2b354fd304b17b71c1c73f76e12d0-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;net&lt;/span&gt; &lt;span class="n"&gt;stop&lt;/span&gt; &lt;span class="n"&gt;w32time&lt;/span&gt;
&lt;a name="rest_code_f3d2b354fd304b17b71c1c73f76e12d0-2"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;w32tm&lt;/span&gt; &lt;span class="p"&gt;/&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="p"&gt;/&lt;/span&gt;&lt;span class="n"&gt;syncfromflags&lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="n"&gt;manual&lt;/span&gt; &lt;span class="p"&gt;/&lt;/span&gt;&lt;span class="n"&gt;manualpeerlist&lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="n"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;centos&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pool&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ntp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;org&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;centos&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pool&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ntp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;org&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;2&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;centos&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pool&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ntp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;org&lt;/span&gt;&lt;span class="err"&gt;”&lt;/span&gt;
&lt;a name="rest_code_f3d2b354fd304b17b71c1c73f76e12d0-3"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;w32tm&lt;/span&gt; &lt;span class="p"&gt;/&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt; &lt;span class="p"&gt;/&lt;/span&gt;&lt;span class="n"&gt;reliable&lt;/span&gt;&lt;span class="err"&gt;:&lt;/span&gt;&lt;span class="n"&gt;yes&lt;/span&gt;
&lt;a name="rest_code_f3d2b354fd304b17b71c1c73f76e12d0-4"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;net&lt;/span&gt; &lt;span class="nb"&gt;start &lt;/span&gt;&lt;span class="n"&gt;w32time&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;FreeIPA ve Active Directory Cross-Realm Trust:&lt;/strong&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;Ilk olarak "ipa-adtrust-install" paketini repodan kuralim:&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class="code bash"&gt;&lt;a name="rest_code_cd50fe50a08e409f9b681be3c944cfb7-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# yum install ipa-adtrust-install&lt;/span&gt;
&lt;/pre&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;IPA Server uzerinde cross-realm islemi icin:&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class="code bash"&gt;&lt;a name="rest_code_84c304852399415fb7a7605880e45db7-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# ipa-adtrust-install --netbios-name=PIESSO -a password&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;Firewall Konfigurasyonu:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Windows Server uzerinde firewall uzerindeki kurallar otomatik olarak ekleniyor. Fakat IPA Server uzerinde asagidaki portlarin acik olmasi gerekmektedir.&lt;/p&gt;
&lt;pre class="code console"&gt;&lt;a name="rest_code_2c06f3642f894df78d1fb1872b4ca1e1-1"&gt;&lt;/a&gt;&lt;span class="go"&gt;TCP ports: 80, 88, 443, 389, 636, 88, 464, 53, 135, 138, 139, 445, 1024-1300&lt;/span&gt;
&lt;a name="rest_code_2c06f3642f894df78d1fb1872b4ca1e1-2"&gt;&lt;/a&gt;&lt;span class="go"&gt;UDP ports: 88, 464, 53, 123, 138, 139, 389, 445&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;Centos 7 ile birlikte gelen firewall manager firewalld spesifik servisleri acmak icin halen yetersiz oldugu icin bunu disabled edip yerine klasik iptables'i aktif edelim:&lt;/p&gt;
&lt;pre class="code bash"&gt;&lt;a name="rest_code_7936879dc97b4b9eaf5562145cfe6248-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# systemctl disable firewalld&lt;/span&gt;
&lt;a name="rest_code_7936879dc97b4b9eaf5562145cfe6248-2"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# systemctl stop firewalld&lt;/span&gt;
&lt;a name="rest_code_7936879dc97b4b9eaf5562145cfe6248-3"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# yum install -y iptables-services&lt;/span&gt;
&lt;a name="rest_code_7936879dc97b4b9eaf5562145cfe6248-4"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# systemctl enable iptables&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;"/etc/sysconfig/iptables" dosyasina gerekli olan portlari acmak icin kurallarimizi girelim:&lt;/p&gt;
&lt;pre class="code console"&gt;&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-1"&gt;&lt;/a&gt;&lt;span class="go"&gt;\*filter&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-2"&gt;&lt;/a&gt;&lt;span class="go"&gt;:INPUT ACCEPT [0:0]&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-3"&gt;&lt;/a&gt;&lt;span class="go"&gt;:FORWARD ACCEPT [0:0]&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-4"&gt;&lt;/a&gt;&lt;span class="go"&gt;:OUTPUT ACCEPT [0:0]&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-5"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-6"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -p icmp -j ACCEPT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-7"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -i lo -j ACCEPT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-8"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-9"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -s ad_ip_address -p tcp -m multiport --dports 389,636 -m state --state NEW,ESTABLISHED -j REJECT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-10"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -p tcp -m multiport --dports 80,88,443,389,636,88,464,53,138,139,445 -m state --state NEW,ESTABLISHED -j ACCEPT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-11"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -p udp -m multiport --dports 88,464,53,123,138,139,389,445 -m state --state NEW,ESTABLISHED -j ACCEPT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-12"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -p udp -j REJECT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-13"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A INPUT -p tcp -j REJECT&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-14"&gt;&lt;/a&gt;&lt;span class="go"&gt;-A FORWARD -j REJECT --reject-with icmp-host-prohibited&lt;/span&gt;
&lt;a name="rest_code_d17d50d3dcd64d7cafcfb7fcbbb681d5-15"&gt;&lt;/a&gt;&lt;span class="go"&gt;COMMIT&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;Iptables servisini baslatabiliriz:&lt;/p&gt;
&lt;pre class="code bash"&gt;&lt;a name="rest_code_fb6326f0f2eb449697d4407f8cdf258b-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# systemctl start iptables&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;DNS Forward Zone:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Active Directory ve FreeIPA'yi inbound ve outbound trust olarak isaretlemeden DNS Forward Zone'lari ekleyelim.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;Windows Server 2012 R2 uzerinde:&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class="code powershell"&gt;&lt;a name="rest_code_0bc6fb2df2394b21916b604a64f2aeee-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;dnscmd&lt;/span&gt; &lt;span class="n"&gt;127&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;1&lt;/span&gt; &lt;span class="p"&gt;/&lt;/span&gt;&lt;span class="n"&gt;ZoneAdd&lt;/span&gt; &lt;span class="n"&gt;piesso&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt; &lt;span class="p"&gt;/&lt;/span&gt;&lt;span class="n"&gt;Forwarder&lt;/span&gt; &lt;span class="n"&gt;172&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;16&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;183&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;128&lt;/span&gt;
&lt;/pre&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;FreeIPA Server uzerinde:&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class="code bash"&gt;&lt;a name="rest_code_8e8c2f18f4c24eb7a9e5071049c3f6ff-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# ipa dnsforwardzone-add pencere.local --forwarder=172.16.183.132 --forward-policy=only&lt;/span&gt;
&lt;/pre&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;Forwarder DNS zone'larin dogru sekilde eklenip eklenmedigi iki tarafta da kontrol edelim:&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;Windows Server 2012 R2 (PowerShell):&lt;/em&gt;&lt;/p&gt;
&lt;pre class="code powershell"&gt;&lt;a name="rest_code_38a558c80c6245fd9f6e9f27a5f0ceaa-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;nslookup&lt;/span&gt;
&lt;a name="rest_code_38a558c80c6245fd9f6e9f27a5f0ceaa-2"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nb"&gt;set &lt;/span&gt;&lt;span class="n"&gt;type&lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="n"&gt;srv&lt;/span&gt;
&lt;a name="rest_code_38a558c80c6245fd9f6e9f27a5f0ceaa-3"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;_ldap&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_tcp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ad_domain&lt;/span&gt;
&lt;a name="rest_code_38a558c80c6245fd9f6e9f27a5f0ceaa-4"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;_ldap&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_tcp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ipa_domain&lt;/span&gt;
&lt;a name="rest_code_38a558c80c6245fd9f6e9f27a5f0ceaa-5"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;quit&lt;/span&gt;
&lt;/pre&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;FreeIPA Server uzerinde:&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class="code bash"&gt;&lt;a name="rest_code_219b8f76489942c79ef7e0fa9e9b08e6-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# dig SRV _ldap._tcp.ipa_domain&lt;/span&gt;
&lt;a name="rest_code_219b8f76489942c79ef7e0fa9e9b08e6-2"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# dig SRV _ldap._tcp.ad_domain&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;Cross-Realm Trust:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Freeipa ile Active Directory arasinda "Two-way trust" konfigurasyonu:&lt;/p&gt;
&lt;pre class="code bash"&gt;&lt;a name="rest_code_fb0605c4ecac40a5867a7a7712d84b87-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# ipa trust-add --type=ad pencere.local --admin Administrator --password --two-way=true&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;"Two-way trust" baglantisinin basarili sekilde kurulup kurulmadigini kontrol edelim:&lt;/p&gt;
&lt;pre class="code bash"&gt;&lt;a name="rest_code_b82b1fe4604a4283ba0a5b7b2c184b32-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# ipa trust-fetch-domains "pencere.local"&lt;/span&gt;
&lt;a name="rest_code_b82b1fe4604a4283ba0a5b7b2c184b32-2"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# ipa trustdomain-find "pencere.local"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;</description><category>active directory</category><category>freeipa</category><guid>https://blog.piesso.com/posts/freeipa-ve-active-directory-entegrasyonu/</guid><pubDate>Sun, 22 Jan 2017 14:20:37 GMT</pubDate></item></channel></rss>