<dl class="simple">
<dt><strong>Kurulum oncesi hazirlik:</strong></dt>
<dd><ol class="arabic simple">
<li><dl class="simple">
<dt>FreeIPA Server 4.4.0-14 ( CentOS 7 )</dt>
<dd><ul class="simple">
<li><p>IPA Server IP Adresi: 172.16.183.128</p></li>
<li><p>IPA Server Hostname: ipaserver.piesso.local</p></li>
<li><p>IPA Domain: piesso.local</p></li>
<li><p>IPA Netbios: PIESSO</p></li>
<li><p>IPA Kerberos realm: PIESSO.LOCAL</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Windows Server 2012 R2</dt>
<dd><ul class="simple">
<li><p>Active Directory IP Adresi: 172.16.183.132</p></li>
<li><p>Active Directory Hostname: ad.pencere.local</p></li>
<li><p>Active Directory Domain: pencere.local</p></li>
<li><p>Active Directory Netbios: PENCERE</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
<p>Windows Server 2012 R2 ve FreeIPA icin kerberos ticket vs gibi sorunlar yasanmamasi icin ntp ile zaman esitlemesi mutlaka baslatilmalidir. FreeIPA kurulumunda ontanimli olarak ntp client &quot;time sync&quot; islemini ntp pool'larindan alarak esitlemektedir. Fakat Windows Server 2012 R2 uzerinde de bunu yapmak icin manuel ntp pool sunucularini girip zaman servisini yeniden baslatilmasi gerekmektedir.</p>
<aside class="admonition warning">
<p class="admonition-title">Warning</p>
<p>2016 Bakanlar Kurulu karari ile yaz saati uygulamasi sona erdigi icin zaman diliminin &quot;+3&quot; oldugunu kontrol edin.</p>
</aside>
<p><em>(Powershell uzerinde)</em></p>
<pre class="code powershell"><a id="rest_code_2d45dcb79a5949998137e4bc0b9f9041-1" name="rest_code_2d45dcb79a5949998137e4bc0b9f9041-1"></a><span class="p">&gt;</span> <span class="n">net</span> <span class="n">stop</span> <span class="n">w32time</span>
<a id="rest_code_2d45dcb79a5949998137e4bc0b9f9041-2" name="rest_code_2d45dcb79a5949998137e4bc0b9f9041-2"></a><span class="p">&gt;</span> <span class="n">w32tm</span> <span class="p">/</span><span class="n">config</span> <span class="p">/</span><span class="n">syncfromflags</span><span class="p">:</span><span class="n">manual</span> <span class="p">/</span><span class="n">manualpeerlist</span><span class="p">:</span><span class="n">0</span><span class="p">.</span><span class="n">centos</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">ntp</span><span class="p">.</span><span class="n">org</span><span class="p">,</span> <span class="n">1</span><span class="p">.</span><span class="n">centos</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">ntp</span><span class="p">.</span><span class="n">org</span><span class="p">,</span> <span class="n">2</span><span class="p">.</span><span class="n">centos</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">ntp</span><span class="p">.</span><span class="n">org</span><span class="err">‚Äù</span>
<a id="rest_code_2d45dcb79a5949998137e4bc0b9f9041-3" name="rest_code_2d45dcb79a5949998137e4bc0b9f9041-3"></a><span class="p">&gt;</span> <span class="n">w32tm</span> <span class="p">/</span><span class="n">config</span> <span class="p">/</span><span class="n">reliable</span><span class="p">:</span><span class="n">yes</span>
<a id="rest_code_2d45dcb79a5949998137e4bc0b9f9041-4" name="rest_code_2d45dcb79a5949998137e4bc0b9f9041-4"></a><span class="p">&gt;</span> <span class="n">net</span> <span class="nb">start </span><span class="n">w32time</span>
</pre><p><strong>FreeIPA ve Active Directory Cross-Realm Trust:</strong></p>
<ul class="simple">
<li><p>Ilk olarak &quot;ipa-adtrust-install&quot; paketini repodan kuralim:</p></li>
</ul>
<pre class="code bash"><a id="rest_code_10d6c20b60f1406c9b00cfa03356c4f2-1" name="rest_code_10d6c20b60f1406c9b00cfa03356c4f2-1"></a><span class="c1"># yum install ipa-adtrust-install</span>
</pre><ul class="simple">
<li><p>IPA Server uzerinde cross-realm islemi icin:</p></li>
</ul>
<pre class="code bash"><a id="rest_code_e7e4908ad10c43d78a6254cf41bc20a9-1" name="rest_code_e7e4908ad10c43d78a6254cf41bc20a9-1"></a><span class="c1"># ipa-adtrust-install --netbios-name=PIESSO -a password</span>
</pre><p><strong>Firewall Konfigurasyonu:</strong></p>
<p>Windows Server uzerinde firewall uzerindeki kurallar otomatik olarak ekleniyor. Fakat IPA Server uzerinde asagidaki portlarin acik olmasi gerekmektedir.</p>
<pre class="code console"><a id="rest_code_ca4fd15f37ef483193de7ce7b83f71f9-1" name="rest_code_ca4fd15f37ef483193de7ce7b83f71f9-1"></a><span class="go">TCP ports: 80, 88, 443, 389, 636, 88, 464, 53, 135, 138, 139, 445, 1024-1300</span>
<a id="rest_code_ca4fd15f37ef483193de7ce7b83f71f9-2" name="rest_code_ca4fd15f37ef483193de7ce7b83f71f9-2"></a><span class="go">UDP ports: 88, 464, 53, 123, 138, 139, 389, 445</span>
</pre><p>Centos 7 ile birlikte gelen firewall manager firewalld spesifik servisleri acmak icin halen yetersiz oldugu icin bunu disabled edip yerine klasik iptables'i aktif edelim:</p>
<pre class="code bash"><a id="rest_code_09137a5b69e644038506824643e609ef-1" name="rest_code_09137a5b69e644038506824643e609ef-1"></a><span class="c1"># systemctl disable firewalld</span>
<a id="rest_code_09137a5b69e644038506824643e609ef-2" name="rest_code_09137a5b69e644038506824643e609ef-2"></a><span class="c1"># systemctl stop firewalld</span>
<a id="rest_code_09137a5b69e644038506824643e609ef-3" name="rest_code_09137a5b69e644038506824643e609ef-3"></a><span class="c1"># yum install -y iptables-services</span>
<a id="rest_code_09137a5b69e644038506824643e609ef-4" name="rest_code_09137a5b69e644038506824643e609ef-4"></a><span class="c1"># systemctl enable iptables</span>
</pre><p>&quot;/etc/sysconfig/iptables&quot; dosyasina gerekli olan portlari acmak icin kurallarimizi girelim:</p>
<pre class="code console"><a id="rest_code_b738619dd251438886259a039134d69e-1" name="rest_code_b738619dd251438886259a039134d69e-1"></a><span class="go">\*filter</span>
<a id="rest_code_b738619dd251438886259a039134d69e-2" name="rest_code_b738619dd251438886259a039134d69e-2"></a><span class="go">:INPUT ACCEPT [0:0]</span>
<a id="rest_code_b738619dd251438886259a039134d69e-3" name="rest_code_b738619dd251438886259a039134d69e-3"></a><span class="go">:FORWARD ACCEPT [0:0]</span>
<a id="rest_code_b738619dd251438886259a039134d69e-4" name="rest_code_b738619dd251438886259a039134d69e-4"></a><span class="go">:OUTPUT ACCEPT [0:0]</span>
<a id="rest_code_b738619dd251438886259a039134d69e-5" name="rest_code_b738619dd251438886259a039134d69e-5"></a><span class="go">-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-6" name="rest_code_b738619dd251438886259a039134d69e-6"></a><span class="go">-A INPUT -p icmp -j ACCEPT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-7" name="rest_code_b738619dd251438886259a039134d69e-7"></a><span class="go">-A INPUT -i lo -j ACCEPT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-8" name="rest_code_b738619dd251438886259a039134d69e-8"></a><span class="go">-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-9" name="rest_code_b738619dd251438886259a039134d69e-9"></a><span class="go">-A INPUT -s ad_ip_address -p tcp -m multiport --dports 389,636 -m state --state NEW,ESTABLISHED -j REJECT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-10" name="rest_code_b738619dd251438886259a039134d69e-10"></a><span class="go">-A INPUT -p tcp -m multiport --dports 80,88,443,389,636,88,464,53,138,139,445 -m state --state NEW,ESTABLISHED -j ACCEPT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-11" name="rest_code_b738619dd251438886259a039134d69e-11"></a><span class="go">-A INPUT -p udp -m multiport --dports 88,464,53,123,138,139,389,445 -m state --state NEW,ESTABLISHED -j ACCEPT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-12" name="rest_code_b738619dd251438886259a039134d69e-12"></a><span class="go">-A INPUT -p udp -j REJECT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-13" name="rest_code_b738619dd251438886259a039134d69e-13"></a><span class="go">-A INPUT -p tcp -j REJECT</span>
<a id="rest_code_b738619dd251438886259a039134d69e-14" name="rest_code_b738619dd251438886259a039134d69e-14"></a><span class="go">-A FORWARD -j REJECT --reject-with icmp-host-prohibited</span>
<a id="rest_code_b738619dd251438886259a039134d69e-15" name="rest_code_b738619dd251438886259a039134d69e-15"></a><span class="go">COMMIT</span>
</pre><p>Iptables servisini baslatabiliriz:</p>
<pre class="code bash"><a id="rest_code_ec17237505ee4b7b9fb0ab7702e985a4-1" name="rest_code_ec17237505ee4b7b9fb0ab7702e985a4-1"></a><span class="c1"># systemctl start iptables</span>
</pre><p><strong>DNS Forward Zone:</strong></p>
<p>Active Directory ve FreeIPA'yi inbound ve outbound trust olarak isaretlemeden DNS Forward Zone'lari ekleyelim.</p>
<ul class="simple">
<li><p>Windows Server 2012 R2 uzerinde:</p></li>
</ul>
<pre class="code powershell"><a id="rest_code_c25bc3c6ff4441bbac2c254e377f7937-1" name="rest_code_c25bc3c6ff4441bbac2c254e377f7937-1"></a><span class="p">&gt;</span> <span class="n">dnscmd</span> <span class="n">127</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">0</span><span class="p">.</span><span class="n">1</span> <span class="p">/</span><span class="n">ZoneAdd</span> <span class="n">piesso</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">Forwarder</span> <span class="n">172</span><span class="p">.</span><span class="n">16</span><span class="p">.</span><span class="n">183</span><span class="p">.</span><span class="n">128</span>
</pre><ul class="simple">
<li><p>FreeIPA Server uzerinde:</p></li>
</ul>
<pre class="code bash"><a id="rest_code_15c699c6438c4fbc96eb8a3c243b1349-1" name="rest_code_15c699c6438c4fbc96eb8a3c243b1349-1"></a><span class="c1"># ipa dnsforwardzone-add pencere.local --forwarder=172.16.183.132 --forward-policy=only</span>
</pre><ul class="simple">
<li><p>Forwarder DNS zone'larin dogru sekilde eklenip eklenmedigi iki tarafta da kontrol edelim:</p></li>
</ul>
<p><em>Windows Server 2012 R2 (PowerShell):</em></p>
<pre class="code powershell"><a id="rest_code_713148add927413997859f926cb90d9d-1" name="rest_code_713148add927413997859f926cb90d9d-1"></a><span class="p">&gt;</span> <span class="n">nslookup</span>
<a id="rest_code_713148add927413997859f926cb90d9d-2" name="rest_code_713148add927413997859f926cb90d9d-2"></a><span class="p">&gt;</span> <span class="nb">set </span><span class="n">type</span><span class="p">=</span><span class="n">srv</span>
<a id="rest_code_713148add927413997859f926cb90d9d-3" name="rest_code_713148add927413997859f926cb90d9d-3"></a><span class="p">&gt;</span> <span class="n">_ldap</span><span class="p">.</span><span class="n">_tcp</span><span class="p">.</span><span class="n">ad_domain</span>
<a id="rest_code_713148add927413997859f926cb90d9d-4" name="rest_code_713148add927413997859f926cb90d9d-4"></a><span class="p">&gt;</span> <span class="n">_ldap</span><span class="p">.</span><span class="n">_tcp</span><span class="p">.</span><span class="n">ipa_domain</span>
<a id="rest_code_713148add927413997859f926cb90d9d-5" name="rest_code_713148add927413997859f926cb90d9d-5"></a><span class="p">&gt;</span> <span class="n">quit</span>
</pre><ul class="simple">
<li><p>FreeIPA Server uzerinde:</p></li>
</ul>
<pre class="code bash"><a id="rest_code_439a826be98c48e3a30ae5af80030e16-1" name="rest_code_439a826be98c48e3a30ae5af80030e16-1"></a><span class="c1"># dig SRV _ldap._tcp.ipa_domain</span>
<a id="rest_code_439a826be98c48e3a30ae5af80030e16-2" name="rest_code_439a826be98c48e3a30ae5af80030e16-2"></a><span class="c1"># dig SRV _ldap._tcp.ad_domain</span>
</pre><p><strong>Cross-Realm Trust:</strong></p>
<p>Freeipa ile Active Directory arasinda &quot;Two-way trust&quot; konfigurasyonu:</p>
<pre class="code bash"><a id="rest_code_07a36f3273a049b0ac54f6bf71f8ff16-1" name="rest_code_07a36f3273a049b0ac54f6bf71f8ff16-1"></a><span class="c1"># ipa trust-add --type=ad pencere.local --admin Administrator --password --two-way=true</span>
</pre><p>&quot;Two-way trust&quot; baglantisinin basarili sekilde kurulup kurulmadigini kontrol edelim:</p>
<pre class="code bash"><a id="rest_code_bd0568f33cf64699babed21788aea7eb-1" name="rest_code_bd0568f33cf64699babed21788aea7eb-1"></a><span class="c1"># ipa trust-fetch-domains &quot;pencere.local&quot;</span>
<a id="rest_code_bd0568f33cf64699babed21788aea7eb-2" name="rest_code_bd0568f33cf64699babed21788aea7eb-2"></a><span class="c1"># ipa trustdomain-find &quot;pencere.local&quot;</span>
</pre>